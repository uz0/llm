<!DOCTYPE html>
<html lang="{{ site.lang | default: "en-US" }}">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{{ site.title }}</title>
    <meta name="description" content="{{ site.description }}">

    <link rel="stylesheet" href="{{ "assets/css/style.css" | relative_url }}">
    <link rel="stylesheet" href="{{ "assets/css/theme.css" | relative_url }}">

    <!-- Mermaid.js for diagram rendering (fixes issue #8) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    {% include head-custom.html %}
  </head>
  <body>
    <div class="site-container">
      <!-- Left Sidebar Navigation -->
      <aside class="sidebar" id="sidebar">
        {% include sidebar_navigation.html %}
      </aside>

      <!-- Main Content Area -->
      <div class="main-content">

        <!-- Main Content -->
        <section class="content">
          <!-- Only show course navigation on docs pages, not main page -->
          {% if page.url != '/' and page.url != '/index.html' %}
            {% include course_navigation.html %}
          {% endif %}

      <!-- Initialize Mermaid diagrams (fixes issue #8) -->
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          if (typeof mermaid !== 'undefined') {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            mermaid.initialize({
              startOnLoad: true,
              theme: prefersDark ? 'dark' : 'default',
              themeVariables: {
                darkMode: prefersDark,
                primaryColor: '#66b3ff',
                primaryTextColor: '#1a1a1a',
                primaryBorderColor: '#66b3ff',
                lineColor: '#888',
                secondaryColor: '#ff9999',
                tertiaryColor: '#99ccff'
              },
              flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
              },
              sequence: {
                useMaxWidth: true,
                wrap: true
              }
            });

            // Handle theme changes for dynamic switching
            if (window.matchMedia) {
              window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
                mermaid.initialize({
                  theme: e.matches ? 'dark' : 'default'
                });
                mermaid.init(undefined, '.mermaid');
              });
            }
          }
        });
      </script>

        {{ content }}
        </section>

        <!-- Footer with social links -->
        <footer class="site-footer">
          <div class="footer-content">
            <div class="footer-left">
              <p>&copy; {{ site.time | date: "%Y" }} LLM Agents Workflow Course. All rights reserved.</p>
            </div>
            <div class="footer-right">
              <div class="social-links">
                <a href="https://github.com/dcversus/llm" target="_blank" rel="noopener" class="social-link">GitHub</a>
                <a href="#" target="_blank" rel="noopener" class="social-link">Twitter</a>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script src="{{ "/assets/js/scale.fix.js" | relative_url }}"></script>

    <!-- Smart Navigation Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        initializeSmartNav();
      });

      function initializeSmartNav() {
        // Highlight current page
        highlightCurrentPage();

        // Generate page navigation from headers
        generatePageNavigation();
      }

      function initializeCollapsibleNav() {
        const toggles = document.querySelectorAll('.section-toggle');

        toggles.forEach(toggle => {
          toggle.addEventListener('click', function() {
            const section = this.getAttribute('data-section');
            const list = document.getElementById(`nav-${section}`);
            const icon = this.querySelector('.toggle-icon');

            if (list) {
              const isExpanded = list.style.display !== 'none';
              list.style.display = isExpanded ? 'none' : 'block';
              icon.textContent = isExpanded ? '▶' : '▼';

              // Save state to localStorage
              localStorage.setItem(`nav-${section}-collapsed`, isExpanded);
            }
          });

          // Restore saved state
          const section = toggle.getAttribute('data-section');
          const isCollapsed = localStorage.getItem(`nav-${section}-collapsed`) === 'true';
          const list = document.getElementById(`nav-${section}`);
          const icon = toggle.querySelector('.toggle-icon');

          if (isCollapsed && list) {
            list.style.display = 'none';
            icon.textContent = '▶';
          }
        });
      }

      function highlightCurrentPage() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.nav-list a[data-page]');

        navLinks.forEach(link => {
          const href = link.getAttribute('href');
          const page = link.getAttribute('data-page');

          if (href === currentPath ||
              currentPath.includes(page) ||
              currentPath.endsWith(page + '.html')) {
            link.classList.add('active');
          }
        });
      }

      function generatePageNavigation() {
        // Only generate on docs pages (not main page)
        if (window.location.pathname === '/') return;

        const headers = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        const pageNav = document.getElementById('page-nav');
        const pageNavList = document.getElementById('nav-page');

        if (headers.length > 2 && pageNav && pageNavList) {
          pageNav.style.display = 'block';
          pageNavList.innerHTML = '';

          headers.forEach((header, index) => {
            // Skip the main title (usually h1)
            if (header.tagName === 'H1') return;

            const id = header.id || `section-${index}`;
            if (!header.id) {
              header.id = id;
            }

            const li = document.createElement('li');
            const level = parseInt(header.tagName.charAt(1));
            const indent = (level - 2) * 12; // h2 = 0, h3 = 12px, etc.

            li.innerHTML = `
              <a href="#${id}" class="page-nav-link" style="padding-left: ${indent}px">
                <span class="nav-icon">${getHeaderIcon(level)}</span>
                ${header.textContent.trim()}
              </a>
            `;

            pageNavList.appendChild(li);
          });

          // Add smooth scrolling
          document.querySelectorAll('.page-nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
              e.preventDefault();
              const targetId = this.getAttribute('href').substring(1);
              const targetElement = document.getElementById(targetId);

              if (targetElement) {
                targetElement.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });

                // Update active state
                document.querySelectorAll('.page-nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
              }
            });
          });
        }
      }

      function getHeaderIcon(level) {
        const icons = {
          2: '-', // h2
          3: '•', // h3
          4: '◦', // h4
          5: '▪',  // h5
          6: '·'   // h6
        };
        return icons[level] || '•';
      }

          </script>

    <!-- MinimalAnalytics (for issue #9) - https://minimalanalytics.com/ -->
    <script>
      (function(a,b,c){var d=a.history,e=document,f=navigator||{},g=localStorage,
      h=encodeURIComponent,i=d.pushState,k=function(){return Math.random().toString(36)},
      l=function(){return g.cid||(g.cid=k()),g.cid},m=function(r){var s=[];for(var t in r)
      r.hasOwnProperty(t)&&void 0!==r[t]&&s.push(h(t)+"="+h(r[t]));return s.join("&")},
      n=function(r,s,t,u,v,w,x){var z="https://www.google-analytics.com/collect",
      A=m({v:"1",ds:"web",aip:c.anonymizeIp?1:void 0,tid:b,cid:l(),t:r||"pageview",
      sd:c.colorDepth&&screen.colorDepth?screen.colorDepth+"-bits":void 0,dr:e.referrer||
      void 0,dt:e.title,dl:e.location.origin+e.location.pathname+e.location.search,ul:c.language?
      (f.language||"").toLowerCase():void 0,de:c.characterSet?e.characterSet:void 0,
      sr:c.screenSize?(a.screen||{}).width+"x"+(a.screen||{}).height:void 0,vp:c.screenSize&&
      a.visualViewport?(a.visualViewport||{}).width+"x"+(a.visualViewport||{}).height:void 0,
      ec:s||void 0,ea:t||void 0,el:u||void 0,ev:v||void 0,exd:w||void 0,exf:"undefined"!=typeof x&&
      !1==!!x?0:void 0});if(f.sendBeacon)f.sendBeacon(z,A);else{var y=new XMLHttpRequest;
      y.open("POST",z,!0),y.send(A)}};d.pushState=function(r){return"function"==typeof d.onpushstate&&
      d.onpushstate({state:r}),setTimeout(n,c.delay||10),i.apply(d,arguments)},n(),
      a.ma={trackEvent:function o(r,s,t,u){return n("event",r,s,t,u)},
      trackException:function q(r,s){return n("exception",null,null,null,null,r,s)}}})
      (window,"GTM-PMQLRD6K",{anonymizeIp:true,colorDepth:true,characterSet:true,screenSize:true,language:true});
    </script>
  </body>
</html>